---
title: "ESM204_HW3"
author: "Katheryn Moya"
date: "5/4/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(here)
library(tidyverse)
library(equatiomatic)
library(broom)
library(janitor)
library(rootSolve)
```

to create a function, we want to sum Qs
step one is to define function to set a demand
function is basically saying that first co


## ACTUAL BEGINNING OF ASSIGNMENT

```{r}
# read in data
energy_demand <- read_csv("HW3_data.csv") %>% 
  select(-1) %>% 
  clean_names()
```

## Question 1
- Current electricity cost is $0.10/kWh
- One kWh electricity emits 0.85 lbs CO^2^
- 2204.62 lbs in 1 metric ton 
- Interim SCC value of $51/metric ton or 5100 cents/metric ton (total external cost)

```{r}
# convert lbs to metric ton
lb_to_ton <- (0.85/2204.62) 
# one kWh electricity emits 0.0003856 metric tons of carbon
MEC <- 5100*lb_to_ton # $.0197
``` 

- MEC = $ `r round((MEC/100), 2)` cents/kWh electricity

## Question 2

```{r}
# define function to get demand curve
low_income <- lm(price_cents ~ q_low_kwh, data = energy_demand)
high_income <- lm(price_cents ~ q_high_kwh, data = energy_demand)
demand <-function(p, model){
  q <- (p - model$coefficients[[1]])/model$coefficients[[2]]
  q <- ifelse(q<0,0,q)  #addresses differences in y-intercepts
  return(q)
}

# for each p level, return estimated aggregate demand
demand_agg <- function(p){
  q <- demand(p, low_income) + demand(p, high_income)
  return(q)
}
price = seq(0, 31.6, length.out = 100)
Qagg <- map(price, demand_agg) %>% unlist()
df2<- tibble(Qagg = Qagg, price = price)
market_q <- demand_agg(10)
#taxcurve <- df2 - MEC
# new aggregate with tax 
demand_tax <- function(p, model){
  q <- (p - (model$coefficients[[1]]-1.97))/model$coefficients[[2]]
  q <- ifelse(q<0,0,q)
  return(q)
}
demand_agg_tax <- function(p){
  q <- demand_tax(p, low_income) + demand(p, high_income) # high consumers are not subjugated to the tax
  return(q)
}
price_tax = seq(0, 31.6, length.out = 100)
Qagg_tax <- map(price, demand_agg_tax) %>% unlist()
df2_tax<- tibble(Qagg = Qagg_tax, price = price_tax)
market_q_tax <- demand_agg_tax(10)
```

```{r}
# create demand and supply curve
ggplot() +
  geom_line(df2, mapping = aes(x = Qagg, y =price, color = "agg. Demand")) +# Agg demand
  geom_line(df2_tax, mapping = aes(x=Qagg_tax, y = price_tax, color = "taxed agg. demand")) + #taxed agg demand
  geom_abline(slope = coef(low_income)[["q_low_kwh"]], 
              intercept = coef(low_income)[["(Intercept)"]], color="purple", linetype="twodash") + # Low consumer demand
  geom_abline(slope = coef(high_income)[["q_high_kwh"]], 
              intercept = coef(high_income)[["(Intercept)"]], color="steelblue", linetype="twodash") + # High consumer demand
  geom_abline(slope = (10/market_q), intercept = 0, color = "orange", aes(value = "supply")) + # supply curve
  geom_abline(slope = 0, intercept = MEC, color = "darkolivegreen3", aes(value = "MEC")) + # MEC
  #geom_abline(slope = (10/market_q), intercept = MEC, color = "purple") + #we need to delete this line because this is a tax on the consumer
  scale_x_continuous(limits = c(0,850000), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0,35), expand = c(0, 0)) +
  labs(x = "Electricity (kWh)", y = "Price (cents)") +
  #geom_line(taxcurve, mapping = aes(x = Qagg, y = price, color = "orange"))+
  theme_bw() +
  scale_color_manual(breaks = c("agg. demand", "taxed agg. demand", "supply", "MEC", "low consumer demand", "high consumer demand"),
                     values = c("agg. demand" = "black", "taxed agg. demand" = "red", "supply" = "orange", "MEC" = "darkolivegreen3", "high consumer demand" = "steelblue", "low consumer demand" = "purple"))
slope_supply <- (10/market_q)
# supply curve equation: P = 0.0000186Q
```

```{r}
# calculating surpluses at market equilibrium
# CS calculation needs Y intercept of high demand/demand agg curve --> at 0 kWh, price would be $0.316
high_sum <-summary.lm(high_income)
high_y_int <- high_sum$coefficients[1, 1] 
low_sum <- summary.lm(low_income)
low_y_int <- low_sum$coefficients[1, 1]
# Converted back to dollars
cs_sq_high <- 0.5*market_q*((high_y_int/100) - 0.10)
# High consumer benefit $57,984.10
cs_sq_low <- 0.5*market_q*((low_y_int/100) - 0.10)
# Low consumer benefit $35,882.29
cs_sq_total <- cs_sq_high + cs_sq_low
# Consumer benefit $93,866.39
ps_sq <- 0.5*market_q*0.10
# Producer benefit $26,835.97
env_cost_sq <- (MEC*market_q)/100
# Environmental cost $10,553.65
```

- Aggregate monthly demand curve is the black curve with a kink, which is the horizontal sum of the low (gold dashed) and high (blue dashed) demand curves.
- The supply curve is the green curve, which represents the marginal private cost curve. Its equation is P = `r round(slope_supply, 7)` Q

Under status quo:

- Consumer benefit = $`r round(cs_sq_total, 2)` 
- Producer benefit = $`r round(ps_sq, 2)`
- Environmental cost = $`r round(env_cost_sq, 2)`

## Question 3

The high-income consumers get much more of total benefit, at `r round(cs_sq_high, 2)` USD compared to `r round(cs_sq_low, 2)`USD for low-income consumers.

## Question 4 

