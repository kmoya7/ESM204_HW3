---
title: "HW 3: Distributional consequences of climate policy"
author: "Grace Bianchi, Claire Meuter, and Katheryn Moya"
date: "5/4/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, options(scipen=999))
library(here)
library(tidyverse)
library(equatiomatic)
library(broom)
library(janitor)
library(rootSolve)
library(PlaneGeometry)
```

to create a function, we want to sum Qs
step one is to define function to set a demand
function is basically saying that first co


## ACTUAL BEGINNING OF ASSIGNMENT
- Current electricity cost is $0.10/kWh
- One kWh electricity emits 0.85 lbs CO^2^
- 2204.62 lbs in 1 metric ton 
- Interim SCC value of $51/metric ton or 5100 cents/metric ton (total external cost)

```{r}
# read in data
energy_demand <- read_csv("HW3_data.csv") %>% 
  select(-1) %>% 
  clean_names()
```

## Question 1
One kWh of electricity emits 0.85 pounds of CO^2^. Assuming that the interim SCC correctly reflects the total social cost of one metric ton of CO2, what is the marginal externality cost per kwH of electricity?

```{r}
# convert lbs to metric ton
lb_to_ton <- (0.85/2204.62) 
# one kWh electricity emits 0.0003856 metric tons of carbon
MEC <- 5100*lb_to_ton # $.0197
``` 

- **MEC = $ `r round((MEC/100), 2)` cents/kWh electricity**

## Question 2

What is the aggregate monthly demand curve for electricity? What is the supply curve for electricity? What is the “benefit” to consumers under the status quo? What is the “benefit” to producers under the status quo? What is the environmental cost under the status quo?

```{r}
# define function to get demand curve
low_income <- lm(price_cents ~ q_low_kwh, data = energy_demand)
high_income <- lm(price_cents ~ q_high_kwh, data = energy_demand)
demand <-function(p, model){
  q <- (p - model$coefficients[[1]])/model$coefficients[[2]]
  q <- ifelse(q<0,0,q)  #addresses differences in y-intercepts
  return(q)
}

# define aggregate demand function
demand_agg <- function(p){
  q <- demand(p, low_income) + demand(p, high_income)
  return(q)
}

price = seq(0, 30, length.out = 100)
Qagg <- map(price, demand_agg) %>% unlist()
agg_energy_demand<- tibble(Qagg = Qagg, price = price)
market_q <- demand_agg(10)

supply_slope <- (10/market_q)
supply <- function(q){
  p <- supply_slope * q
  return (p)
}

```

```{r}
# create demand and supply curve
ggplot() +
  geom_line(agg_energy_demand, mapping = aes(x = Qagg, y =price, color = "agg. Demand")) +# Agg demand
  #geom_line(agg_energy_demand_tax, mapping = aes(x=Qagg_tax, y = price_tax, color = "taxed agg. demand")) + #taxed agg demand
  geom_abline(slope = coef(low_income)[["q_low_kwh"]], 
              intercept = coef(low_income)[["(Intercept)"]], color="purple", linetype="twodash") + # Low consumer demand
  geom_abline(slope = coef(high_income)[["q_high_kwh"]], 
              intercept = coef(high_income)[["(Intercept)"]], color="steelblue", linetype="twodash") + # High consumer demand
  geom_abline(slope = (10/market_q), intercept = 0, color = "orange", aes(value = "supply")) + # supply curve
  geom_abline(slope = 0, intercept = MEC, color = "darkolivegreen3", aes(value = "MEC")) + # MEC
  scale_x_continuous(limits = c(0,850000), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0,35), expand = c(0, 0)) +
  labs(x = "Electricity (kWh)", y = "Price (cents)") +
  #geom_line(taxcurve, mapping = aes(x = Qagg, y = price, color = "orange"))+
  theme_bw() +
  scale_color_manual(breaks = c("agg. demand", "supply", "MEC", "low consumer demand", "high consumer demand"),
                     values = c("agg. demand" = "black", "supply" = "orange", "MEC" = "darkolivegreen3", "high consumer demand" = "steelblue", "low consumer demand" = "purple"))

```

The aggregate monthly demand curve (black line) is the horizontal sum of the low income and the high income demand curves (dashed lines). The supply or MPC curve (orange line) is P = `r supply_slope` Q


```{r}
# consumer surplus for low and high income
CS <- function(p, model) {
  q <- demand(p, model)
  cs <- 0.5 *(model$coefficient[[1]]- p)*q
  return(cs)
}
low_income_CS <- CS(low_income, p = 10) / 100
high_income_CS <- CS(high_income, p = 10) /100

# consumer surplus of agg. demand
CS_agg <- function(p){
  cs <- CS(p, low_income) + CS(p, high_income) # should low_income_cs be used here instead of initial demand
  return(cs)
}
# plug in P* and divide by 100 to get $
CS_total <- CS_agg(p=10) / 100

# producer surplus
PS <- function(q){
  0.5*supply(q) *q
}

PS_total <- PS(market_q) / 100

env_cost <- MEC * market_q

```


Under status quo:

- **Consumer benefit = $`r round(CS_total, 2)` **
- **Producer benefit = $`r round(PS_total, 2)` **
- **Environmental cost = $`r round(env_cost, 2)` **

## Question 3
3. How is the current consumer benefit divided between “high” and “low” income consumers?

**The high-income consumers receive $ `r round(high_income_CS, 2)` and the
low-income consumers receive $`r round(low_income_CS, 2)`**

## Question 4 
Derive the optimal electricity tax (in cents per kWh) using the interim SCC. Noting that recent research has shown the poor face a disproportionate share of the impacts from climate change, assume that the climate externality is borne entirely by the “low” income group. What would be the effects of this tax on:

(a) The amount of electricity produced and consumed
- 2204.62 lbs in 1 metric ton 
- Interim SCC value of $51/metric ton or 5100 cents/metric ton (total external cost)
```{r}
#taxcurve <- agg_energy_demand - MEC

# new aggregate with tax 
demand_tax <- function(p, model){
  q <- (p - (model$coefficients[[1]]- MEC ))/model$coefficients[[2]]
  q <- ifelse(q<0,0,q)
  return(q)
}

demand_agg_tax <- function(p){
  q <- demand_tax(p, low_income) + demand(p, high_income) 
  return(q)
}

price_tax = seq(0, 30, length.out = 100)
Qagg_tax <- map(price, demand_agg_tax) %>% unlist()

agg_energy_demand_tax<- tibble(Qagg = Qagg_tax, price = price_tax)
market_p_tax <- demand_agg_tax(10) # P*
#plug in market_q_tax into new demand tax equation
market_q_tax <- demand_agg_tax(10)


```

```{r}

supply_pointx <- 15/supply_slope

tax_demand_line <- Line$new(B = c(801868.98,0), A = c(235880.43,20))
supply_line <- Line$new(A = c(0,0), B = c(supply_pointx, 15))
tax_intersect <- intersectionLineLine(tax_demand_line, supply_line)
# 525035.350330      9.782305
```

**The optimal amount of electricity is $`r round(tax_intersect[1], 2)`
and the optimal electricity tax is $`r round(tax_intersect[2], 2)`**

(b) The price of electricity
(c) Overall welfare of "high" income consumers
(d) Overall welfare of "low" income consumers
(e) Power suppliers
(f) Total environmental damage
(g) Total tax revenue generated

